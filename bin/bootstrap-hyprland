#!/usr/bin/env bash

source ~/bin/lib

CONSOLE_FONT="ter-220b"

installParu() {
    info "Installing Paru."

    if [[ ! -d "$HOME/dev" ]]; then
        mkdir ~/dev > /dev/null
    fi

    pushd "$HOME/dev" || exit 1

    if [[ ! -d "$HOME/dev/paru" ]]; then
        git clone https://aur.archlinux.org/paru.git
    fi

    cd paru || exit 1

    makepkg -si

    popd || exit 1
}

setupTheme() {
    # Remove Thunar's existing SetWallPaper menu item
    if [[ -f /usr/lib/thunarx-3/thunar-wallpaper-plugin.so ]]; then
        plugin="/usr/lib/thunarx-3/thunar-wallpaper-plugin.so"
        info "Removing Thunar wallpaper plugin."
        sudo rm $plugin
        #pacman_exclude($plugin)
    fi

    # Populate color configs
    info "Setting wallpaper and theme."
    ~/bin/paper both ~/Pictures/Wallpapers/current > /dev/null

    # Set GTK themes / keybindings.
    info "Setting up GTK."
    gsettings set org.gnome.desktop.interface gtk-theme Prof-Gnome-Light-DS
    gsettings set org.gnome.desktop.interface icon-theme kora
    gsettings set org.gnome.desktop.interface gtk-key-theme "Emacs"
    gsettings set org.gnome.desktop.interface font-name "Cantarell 10"
    gsettings set org.gnome.desktop.interface document-font-name "Cantarell 12"
    gsettings set org.gnome.desktop.interface monospace-font-name "Source Code Pro 12"
    gsettings set org.gnome.desktop.interface color-scheme prefer-light

    # Update kora icon theme to use MoreWaita as a fallback.
    if [[ ! $(grep "morewaita" /usr/share/icons/kora/index.theme) ]]; then
        info "Adding MoreWaita as fallback to Kora icons."
        sudo sed -i -r 's/^Inherits=.*$/Inherits=morewaita/' /usr/share/icons/kora/index.theme
    fi

    # Setup plymouth theme
    info "Setting plymouth theme."
    sudo plymouth-set-default-theme -R cyanide
}

setupDisplayManager() {
    info "Setting up Greetd/"
    sudo mkdir -p /etc/geetd
    sudo cp ~/.config/greetd/config.toml /etc/greetd/
}

setupNetworkManager() {
    info "Configuring network-manager (using iwd as wireless backend)".
    sudo mkdir -p /etc/iwd
    sudo cp ~/.config/networking/iwd_main.conf /etc/iwd/main.conf
    sudo mkdir -p /etc/NetworkManager/conf.d/
    sudo cp ~/.config/networking/nm_wifi_backend.conf /etc/NetworkManager/conf.d/wifi_backend.conf

    sudo systemctl enable NetworkManager
    sudo systemctl disable wpa_supplicant
    sudo systemctl enable iwd
}

setupServices() {
    # List of system services to enable/start.
    services=(avahi-daemon
              bluetooth \
              greetd \
              opensnitchd)

    # List of user services to enable/start.
    user_services=(emacs foot-server mpd)

    info "Enabling system services."
    for service in "${services[@]}"; do
        sudo systemctl enable "$service"
    done

    info "Enabling user services."
    for service in "${user_services[@]}"; do
        systemctl --user enable "$service"
    done
}

setupEnvironment() {
    # Readable font in the TTY
    setfont $CONSOLE_FONT
    if [[ ! $(grep $CONSOLE_FONT /etc/vconsole.conf) ]]; then
        echo "FONT=$CONSOLE_FONT" | sudo tee -a /etc/vconsole.conf
    fi

    # Set standard XDG user directories
    info "Upading XDG user directories."
    xdg-user-dirs-update

    # I don't plan on deleting these dierectories, so a service to ensure they
    # still exist is wasted overhead.XS
    sudo systemctl --global disable xdg-user-dirs-update

    # Setup default mime-types
    info "Setting mime-type defaults."
    "$HOME"/bin/set-mime-defaults.sh

    # Setup locale
    info "Setting XDG locale."
    echo "$LANG" | cut -f1 -d. > ~/.config/user-dirs.locale

    # Download tldr content
    info "Updating tldr database."
    tldr --update

    # Give gnome-keyring-daemon permission to tell the kernel not to store its
    # memory into swap, as it contains secrests and 'things'.
    info "Setting capabilities for gnome-keyring-daemon."
    sudo setcap cap_ipc_lock=+ep /usr/bin/gnome-keyring-daemon

    # Sets umask and prevents various kernel modules from being loaded.
    info "Running hardening script."
    ~/.config/harden/harden.sh
}

installPackages() {
    basics="man linux-firmware openssh terminus-font"
    browser="firefox"
    desktop="avahi \
         blueman \
         cliphist wl-clipboard \
         pamixer pavucontrol \
         hyprland hyprlock hypridle hyprshot
         evince \
         feh \
         foliate \
         galculator \
         pipewire pipewire-pulse wireplumber \
         journalctl-desktop-notification \
         mpd rmpc \
         nwg-displays nwg-drawer \
         uwsm
         swaylock \
         swww \
         waybar \
         wlogout \
         vlc vlc-plugin-ffmpeg \
         xdg-desktop-portal-hyprland xdg-desktop-portal-gtk \
         xdg-user-dirs xdg-terminal-exec\
         xfce4-notifyd"
    development="cmake make"
    # I build Emacs manualy, so not included here.  Vi?  Vim?  Never heard of
    # em.
    editor="aspell aspell-en tree-sitter"
    file_manager="file-roller \
         ffmpegthumbnailer \
         gvfs gvfs-smb \
         libgsf poppler-glib \
         nfs-utils \
         thunar thunar-archive-plugin thunar-volman \
         thunar-media-tags-plugin \
         tumbler tumbler-extra-thumbnailers"
    fonts="adobe-source-code-pro-fonts \
         font-manager \
         otf-font-awesome \
         noto-fonts noto-fonts-cjk noto-fonts-emoji \
         ttf-linux-libertine ttf-liberation \
         ttf-sourcecodepro-nerd"
    greeter="greetd greetd-tuigreet"
    libraries="libgccjit lua-luv"
    networking="iwd networkmanager network-manager-applet"
    security="lxsession \
              opensnitch
              python-qt-material"
    terminal="bash-completion foot starship tealdeer"
    theme="kora-icon-theme morewaita-icon-theme prof-gnome-theme-git \
         imagemagick \
         plymouth-theme-cyanide-git \
         python-pywal16 \
         qt6ct"
    utilities="7zip zip unrar-free unzip \
         btop htop \
         bat bat-extras \
         btrfs-assistant \
         figlet \
         fzf
         lshw lsof \
         mc \
         ncdu \
         pacman-contrib \
         pciutils \
         qman \
         ripgrep \
         util-linux \
         tree"

    to_install="$basics    \
         $browser          \
         $desktop          \
         $development      \
         $editor           \
         $file_manager     \
         $fonts            \
         $greeter          \
         $libraries        \
         $networking       \
         $security         \
         $terminal         \
         $theme            \
         $utilities"

    # Install requirements for bootstrap
    info Installing git and base-devel.
    paru --needed -S git base-devel

    # Install packages
    info "Installing packages."
    paru --needed --skipreview -Syu $to_install

    if [[ "$?" -ne 0 ]]; then
        exit
    fi
}

run() {
    while true; do
        read -p "$1" yn
        case $yn in
            [Yy] )
                $2; break;;
            [Nn] )
                break;;
        esac
    done
}

# Install paru if missing.
which paru > /dev/null || installParu

run "Install packages? " installPackages
run "Setup theme? " setupTheme
run "Setup displaymanager? " setupDisplayManager
run "Setup Network Manager? " setupNetworkManager
run "Setup environment? " setupEnvironment
run "Setup services? " setupServices

info Rebuiding kernel init images
sudo mkinitcpio -P

echo "Reboot recomnended to start all services."
