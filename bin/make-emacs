#!/bin/sh

set -o errexit

mkdir -p ~/dev

pushd ~/dev

if [[ ! -d "emacs" ]]; then
    git clone https://github.com/emacs-mirror/emacs --depth=1 --branch=emacs-30
    pushd emacs

    ./autogen.sh

    ./configure --with-pgtk \
                --with-tree-sitter \
                --with-sound=no \
                --with-imagemagick \
                --without-selinux \
                --without-gconf \
                --without-gsettings \
                --without-xinput2 \
                --disable-gc-mark-trace \
                --without-toolit-scroll-bars \
                --without-xaw3d \
                --without-xim \
                --without-xdbe \
                --with-small-ja-dic
else
    pushd emacs
    make clean
    git pull
fi

export CFLAGS="-march=native -O2 -pipe -fomit-frame-pointer"
export MAKEFLAGS="-j$(nproc)"

make && sudo make install

popd
popd
